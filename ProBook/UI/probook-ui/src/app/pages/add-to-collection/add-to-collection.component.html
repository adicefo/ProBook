<h2 mat-dialog-title>Add to Collection</h2>

<mat-dialog-content class="dialog-content">

    <!-- Notebook Info (readonly) -->
    <div class="notebook-info">
        <label class="info-label">Notebook</label>
        <div class="notebook-display">
            <i class="bi bi-journal-text"></i>
            <span>{{ notebook?.name }}</span>
        </div>
    </div>

    <!-- Collection Search Section -->
    <div class="collection-search-section" *ngIf="!showCreateNew">
        <div class="section-header">
            <label class="info-label">Search Collection</label>
            <button class="btn-toggle" (click)="toggleCreateNew()" title="Create new collection">
                <i class="bi bi-plus-circle"></i>
                <span>Create New</span>
            </button>
        </div>

        <!-- Search Input -->
        <div class="input-group">
            <span class="input-icon"><i class="bi bi-search"></i></span>
            <input type="text" [formControl]="nameFilter" placeholder="Search collections..." class="form-control"
                (focus)="onFilterFocus()" />
        </div>

        <!-- Collection Dropdown -->
        <div class="collection-dropdown" *ngIf="showDropdown && !loading">
            <div class="collection-list">
                <div class="collection-item" *ngFor="let collection of filteredCollections"
                    (click)="selectCollection(collection)">
                    <div class="collection-icon">
                        <i class="bi bi-folder2-open"></i>
                    </div>
                    <div class="collection-details">
                        <div class="collection-name">{{ collection.name }}</div>
                        <div class="collection-date" *ngIf="collection.createdAt">
                            {{ collection.createdAt }}
                        </div>
                    </div>
                </div>

                <div class="no-results" *ngIf="filteredCollections.length === 0">
                    <i class="bi bi-inbox"></i>
                    <span>No collections found</span>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="loading-state" *ngIf="loading">
            <mat-spinner diameter="30"></mat-spinner>
            <span>Loading collections...</span>
        </div>
    </div>

    <!-- Create New Collection Section -->
    <div class="create-new-section" *ngIf="showCreateNew">
        <div class="section-header">
            <label class="info-label">Create New Collection</label>
            <button class="btn-toggle" (click)="toggleCreateNew()" title="Back to search">
                <i class="bi bi-arrow-left"></i>
                <span>Back to Search</span>
            </button>
        </div>

        <div class="create-form">
            <!-- Collection Name Input -->
            <div class="form-field">
                <label class="field-label">Name <span class="required">*</span></label>
                <input type="text" [formControl]="newCollectionName" placeholder="Enter collection name..."
                    class="form-control" maxlength="100" />
            </div>

            <!-- Collection Description Input -->
            <div class="form-field">
                <label class="field-label">Description</label>
                <textarea [formControl]="newCollectionDescription" placeholder="Enter description (optional)..."
                    class="form-control textarea-control" rows="3" maxlength="500"></textarea>
            </div>

            <!-- Create Button -->
            <button class="btn-create" (click)="createNewCollection()"
                [disabled]="!newCollectionName.value?.trim() || creating">
                <mat-spinner *ngIf="creating" diameter="20"></mat-spinner>
                <i *ngIf="!creating" class="bi bi-plus-lg"></i>
                <span>{{ creating ? 'Creating...' : 'Create Collection' }}</span>
            </button>
        </div>
    </div>

    <!-- Selected Collection Display -->
    <div class="selected-collection-section" *ngIf="selectedCollection">
        <label class="info-label">Selected Collection</label>
        <div class="selected-collection-card">
            <div class="collection-info">
                <div class="collection-icon-large">
                    <i class="bi bi-folder2-open"></i>
                </div>
                <div class="collection-details">
                    <div class="collection-name-large">{{ selectedCollection.name }}</div>
                    <div class="collection-description" *ngIf="selectedCollection.description">
                        {{ selectedCollection.description }}
                    </div>
                </div>
            </div>
            <button class="btn-remove" (click)="removeSelectedCollection()" title="Remove selection">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>

</mat-dialog-content>

<mat-dialog-actions align="end">
    <button mat-button (click)="cancel()">Cancel</button>
    <button mat-raised-button color="primary" (click)="save()" [disabled]="!selectedCollection || loading">
        <span>Add</span>
    </button>
</mat-dialog-actions>